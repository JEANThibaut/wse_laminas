<?php $activeMenu = $this->layout()->getVariable('activeMenu') ?? ''; ?>
<?php $disablePtr = $this->layout()->getVariable('disablePtr') ?? false; ?>
<?php $isFunny = true; ?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <?= $this->headTitle('Wolf Soft Eure') ?>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <!-- Datepicker JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>

        <?= $this->headLink()->prependStylesheet($this->basePath('assets/css/custom.css') . '?v=' . time()) ?>

    <style>
        /* Pull-to-refresh indicator (circular arrow) */
        #ptr-indicator{
            position: fixed;
            top: 54px;
            left: 50%;
            transform: translate(-50%, -120%);
            z-index: 11000;
            transition: transform 200ms ease, opacity 200ms ease;
            opacity: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #ptr-indicator.visible{ opacity: 1; }
        #ptr-indicator svg{ height: 36px; width: 36px; display:block; }
        /* optional stroke color */
        #ptr-indicator svg circle, #ptr-indicator svg path{ stroke: #01003f5b; fill: none; stroke-width: 2.5; }
    </style>

</head>



<body>
<div id="wrapper" class="fade-in">
<!-- Top Navbar with Menu toggle and Logo -->
<nav class="navbar navbar-light bg-dark px-3">
    <div class="d-flex align-items-center">
        <!-- Menu button -->
        <button class="btn me-2" style="color:white;" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
            ☰
        </button>

        <!-- Logo cliquable -->
        <a href="<?= $this->url('home') ?>" class="logo d-flex align-items-center text-decoration-none">
            <img src="/images/WSE.png" alt="Logo" class="logo-default" style="height: 30px;">
            <img src="/images/WSE_hover.png" alt="Logo hover" class="logo-hover" style="height: 30px;">
        </a>
    </div>
</nav>


    <!-- Offcanvas Sidebar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
        <div class="offcanvas-header bg-dark">
            <h5 class="offcanvas-title"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
        </div>
      <div class="offcanvas-body bg-dark d-flex  flex-column justify-content-between p-0">
    <ul class="nav flex-column">
        <li class="nav-item">
 
            <a class="nav-link <?= ($activeMenu === 'home') ? 'active' : '' ?>" href="<?= $this->url('home') ?>">
                <?php if($isFunny): ?>
                    <img class=" mb-1" src="/images/icones/home.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>
                Accueil
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link <?= ($activeMenu === 'photo-index') ? 'active' : '' ?>" href="<?= $this->url('photo-index') ?>">
                 <?php if($isFunny): ?>
                    <img class="mb-1" src="/images/icones/gallery.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>
                Les photos
            </a>
        </li>
        <li class="nav-item d-none">
            <a class="nav-link <?= ($activeMenu === 'annonce-index') ? 'active' : '' ?>" href="<?= $this->url('annonce-index') ?>">
                <?php if($isFunny): ?>
                    <img class="" src="/images/icones/payment-method.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>    
            Petites annonces</a>
        </li>
        <!-- <li class="nav-item">
            <a class="nav-link <?= ($activeMenu === 'forum') ? 'active' : '' ?>" href="/forum-index">
                <?php if($isFunny): ?>
                    <img class="" src="/images/icones/forum.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>    
            Forum</a>
        </li> -->

        <li class="nav-item">
            <a class="nav-link <?= ($activeMenu === 'faq') ? 'active' : '' ?>" href="/faq">
                <?php if($isFunny): ?>
                    <img class=" mb-1" src="/images/icones/customer-care.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>        
            F.A.Q / Contact
            </a>
        </li>

        <?php if ($this->currentUser) : ?>
            <hr>
            <h4>Profil</h4>
            <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'profil') ? 'active' : '' ?>" href="<?= $this->url('profil-index') ?>">
                <?php if($isFunny): ?>
                    <img class="mb-1" src="/images/icones/verified.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>            
                Mon profil</a>
            </li>
            <!-- <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'arsenal') ? 'active' : '' ?>" href="<?= $this->url('arsenal') ?>">
                    <?php if($isFunny): ?>
                        <img class="mb-1" src="/images/icones/magazine.png" alt="type" style="height: 20px; margin-right:10px;">
                    <?php endif ?>         
                    Mon Arsenal
                </a>
            </li> -->
          
            <?php if ($this->currentUser->getFaction() != null) : ?>
                <li class="nav-item">
                    <a class="nav-link <?= ($activeMenu === 'faction') ? 'active' : '' ?>" href="<?= $this->url('faction') ?>">
                        <?php if($isFunny): ?>
                            <img class="mb-1" src="/images/icones/magazine.png" alt="type" style="height: 20px; margin-right:10px;">
                        <?php endif ?>         
                        Factions War
                    </a>
                </li>
            <?php endif; ?>
        <?php endif; ?>
        <?php if ($this->currentUser && $this->currentUser->getIsMember()) : ?>
             <hr>
            <h4>Espace membres</h4>
            <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'admin-index') ? 'active' : '' ?>" href="<?= $this->url('admin-next-games') ?>">
                    <?php if($isFunny): ?>
                        <img class="mb-1" src="/images/icones/online-game.png" alt="type" style="height: 20px; margin-right:10px;">
                    <?php endif ?>        
                    Prochaine partie
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'admin-index') ? 'active' : '' ?>" href="<?= $this->url('admin-next-games') ?>">
                    <?php if($isFunny): ?>
                        <img class="mb-1" src="/images/icones/checklist.png" alt="type" style="height: 20px; margin-right:10px;">
                    <?php endif ?>            
                    Prochain aménagement
                </a>
            </li>            

        <?php endif; ?>
            <?php if ($this->currentUser && $this->currentUser->getIsAdmin()) : ?>
            <hr>
            <h4>Espace Administration</h4>
            <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'admin-users') ? 'active' : '' ?>" href="<?= $this->url('admin-users') ?>">
                    <?php if($isFunny): ?>
                        <img class="mb-1" src="/images/icones/management.png" alt="type" style="height: 20px; margin-right:10px;">
                    <?php endif ?>        
                    Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'admin-games') ? 'active' : '' ?>" href="<?= $this->url('admin-games') ?>">
                <?php if($isFunny): ?>
                    <img class="mb-1" src="/images/icones/game-development.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>          
                Les parties
                </a>
            </li>
              <li class="nav-item">
                <a class="nav-link <?= ($activeMenu === 'actus-admin') ? 'active' : '' ?>" href="<?= $this->url('actus-admin') ?>">
                <?php if($isFunny): ?>
                    <img class="mb-1" src="/images/icones/game-development.png" alt="type" style="height: 20px; margin-right:10px;">
                <?php endif ?>          
                Les actualités
                </a>
            </li>
        <?php endif; ?>
    </ul>

    <?php if ($this->currentUser): ?>

        <div class="mb-3">
            <a class="btn btn-outline-danger w-100" href="<?= $this->url('logout') ?>">Se déconnecter</a>
        </div>


          <?php else : ?>
        <div class="mb-3">
            <a class="btn btn-outline-success w-100" href="<?= $this->url('login') ?>">Se connecter / S'inscrire</a>
        </div>

    <?php endif; ?>
</div>

    </div>

        <!-- Pull-to-refresh indicator -->
        <div id="ptr-indicator" aria-hidden="true">
            <!-- circular arrow SVG -->
            <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="24" cy="24" r="16" stroke-linecap="round" stroke-linejoin="round"></circle>
                <path d="M34 14 L34 24 L24 24" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
        </div>

        <!-- Main content -->
            <main class="container-fluid mt-4 fade-in" id="ptr-content" <?= $disablePtr ? 'data-ptr="off"' : '' ?>>
                <?= $this->content ?>
            </main>
    <!-- Footer -->
    <footer class="text-center mt-5 mb-3 text-muted">
     
    </footer>

</div> <!-- end #wrapper -->





<!-- Flash messages -->
<div class="container mt-3 position-absolute start-50 translate-middle-x" style="z-index: 9999; top: 20px;">
    <?php foreach ($this->flashMessenger()->getMessages() as $message): ?>
        <div class="alertGlobal alert alert-info"><?= $this->escapeHtml($message) ?></div>
    <?php endforeach; ?>
    <?php foreach ($this->flashMessenger()->getErrorMessages() as $message): ?>
        <div class="alertGlobal alert alert-danger"><?= $this->escapeHtml($message) ?></div>
    <?php endforeach; ?>
    <?php foreach ($this->flashMessenger()->getSuccessMessages() as $message): ?>
        <div class="alertGlobal alert alert-success"><?= $this->escapeHtml($message) ?></div>
    <?php endforeach; ?>
    <?php foreach ($this->flashMessenger()->getWarningMessages() as $message): ?>
        <div class="alertGlobal alert alert-warning"><?= $this->escapeHtml($message) ?></div>
    <?php endforeach; ?>
</div>


<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom scripts -->
<?= $this->inlineScript()
    ->prependFile($this->basePath('assets/js/custom.js') . '?v=' . time()) ?>

<script>
    // Auto-hide des alertes flash
    setTimeout(() => {
        document.querySelectorAll('.alertGlobal').forEach(el => {
            el.style.transition = 'opacity 0.5s';
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 500);
        });
    }, 4000);



document.addEventListener('DOMContentLoaded', function () {
    console.log("Initialisation datepicker...");

    const dateFields = document.querySelectorAll('.datepicker');
    console.log("Nb champs datepicker trouvés :", dateFields.length);

    if (dateFields.length > 0) {
        dateFields.forEach(input => {
            console.log("Champ date visible: ", input.offsetParent !== null);
            flatpickr(input, {
                dateFormat: "d/m/Y",
                locale: "fr",
                disableMobile: true
            });
        });
    } else {
        console.warn("Aucun champ datepicker trouvé.");
    }
});

</script>
<script>
    // Pull-to-refresh mobile (non-intrusive) with logo indicator
    (function(){
        const el = document.getElementById('ptr-content');
        const indicator = document.getElementById('ptr-indicator');
        if (!el || !indicator) return;

        // Skip PTR when page explicitly disables it via data attribute
        if (el.dataset && el.dataset.ptr === 'off') return;

        const PTR_THRESHOLD = 80; // px needed to trigger refresh
        let startY = 0;
        let dist = 0;
        let pulling = false;

        function onTouchStart(e){
            if (!(e.touches && e.touches.length === 1)) return;

            const touchAtTopOfWindow = window.scrollY === 0;
            const contentIsScrollable = el.scrollHeight > el.clientHeight;
            const touchAtTopOfContent = el.scrollTop === 0;

            // If the page itself is the scrolling container, require window at top.
            // If the content element is the scrolling container, require the element at top.
            const allowed = contentIsScrollable ? touchAtTopOfContent : touchAtTopOfWindow;

            if (allowed) {
                startY = e.touches[0].clientY;
                dist = 0;
                pulling = true;
            }
        }

        function onTouchMove(e){
            if (!pulling) return;
            const y = e.touches[0].clientY;
            dist = y - startY;
            if (dist > 0) {
                // Damp the translation for a smoother feel
                const damp = Math.min(dist / 2, PTR_THRESHOLD * 1.5);
                el.style.transform = `translateY(${damp}px)`;
                el.style.transition = 'transform 0s';

                // Move and reveal indicator slightly behind the pulled content
                indicator.classList.add('visible');
                indicator.style.transition = 'transform 0s, opacity 0s';
                const indY = Math.max(damp - 48, -32);
                indicator.style.transform = `translate(-50%, ${indY}px)`;

                // rotate a bit based on progress (SVG)
                const progress = Math.min(damp / PTR_THRESHOLD, 1);
                const svg = indicator.querySelector('svg');
                if (svg) {
                    svg.style.transform = `rotate(${progress * 360}deg) scale(${1 + progress*0.05})`;
                    svg.style.transition = 'transform 0s';
                }
            } else {
                el.style.transform = '';
                indicator.classList.remove('visible');
            }
        }

        function onTouchEnd(){
            if (!pulling) return;
            pulling = false;
            el.style.transition = 'transform 300ms ease';
            el.style.transform = '';
            indicator.style.transition = 'transform 300ms ease, opacity 300ms ease';
            indicator.style.transform = 'translate(-50%, -120%)';
            indicator.classList.remove('visible');

            if (dist >= PTR_THRESHOLD) {
                // brief feedback animation on SVG then reload
                const svg = indicator.querySelector('svg');
                if (svg) {
                    svg.style.transition = 'transform 200ms ease';
                    svg.style.transform = 'rotate(360deg) scale(0.95)';
                }
                indicator.classList.add('visible');
                indicator.style.transform = 'translate(-50%, 10px)';
                setTimeout(() => {
                    window.location.reload();
                }, 220);
            }
        }

        // Use passive listeners so we don't break scrolling behaviour; we only read values and transform.
        document.addEventListener('touchstart', onTouchStart, {passive: true});
        document.addEventListener('touchmove', onTouchMove, {passive: true});
        document.addEventListener('touchend', onTouchEnd);
    })();
</script>

</body>
</html>
